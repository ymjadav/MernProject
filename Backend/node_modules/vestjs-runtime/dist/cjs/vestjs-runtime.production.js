"use strict";var t=require("vest-utils"),e=require("context"),n=require("vest-utils/minifyObject");const r={ISOLATE_ENTER:"ISOLATE_ENTER",ISOLATE_PENDING:"ISOLATE_PENDING",ISOLATE_DONE:"ISOLATE_DONE"};var o;"function"==typeof SuppressedError&&SuppressedError,function(t){t.NO_ACTIVE_ISOLATE="Not within an active isolate",t.UNABLE_TO_PICK_NEXT_ISOLATE="Unable to pick next isolate. This is a bug, please report it to the Vest maintainers.",t.ENCOUNTERED_THE_SAME_KEY_TWICE='Encountered the same key "{key}" twice. This may lead to inconsistent or overriding of results.',t.INVALID_ISOLATE_CANNOT_PARSE="Invalid isolate was passed to IsolateSerializer. Cannot proceed."}(o||(o={}));class i{static at(e,n){var r,o;return t.isNullish(e)?null:null!==(o=null===(r=e.children)||void 0===r?void 0:r[n])&&void 0!==o?o:null}static cursor(e){var n,r;return t.isNullish(e)?0:null!==(r=null===(n=e.children)||void 0===n?void 0:n.length)&&void 0!==r?r:0}static canReorder(e){return!t.isNullish(e)&&i.allowsReorder(e.parent)}static allowsReorder(t){return!0===(null==t?void 0:t.allowReorder)}static usesKey(e){return!t.isNullish(e)&&t.isNotNullish(e.key)}static getChildByKey(e,n){var r,o;return t.isNullish(e)?null:null!==(o=null===(r=e.keys)||void 0===r?void 0:r[n])&&void 0!==o?o:null}}class s{static setParent(t,e){return t.parent=e,t}static saveOutput(t,e){return t.output=e,t}static setKey(t,e){return t.key=e,t}static addChild(e,n){var r;t.invariant(e),e.children=null!==(r=e.children)&&void 0!==r?r:[],e.children.push(n),s.setParent(n,e)}static removeChild(t,e){var n,r;t.children=null!==(r=null===(n=t.children)||void 0===n?void 0:n.filter((t=>t!==e)))&&void 0!==r?r:null}static addChildKey(e,n,r){var o;t.invariant(e),e.keys=null!==(o=e.keys)&&void 0!==o?o:{},e.keys[n]=r}static slice(e,n){t.isNullish(e.children)||(e.children.length=n)}static setData(t,e){t.data=e}static abort(e,n){t.isNullish(e.abortController)||e.abortController.abort(n)}}const l=e.createCascade(((e,n)=>{if(n)return null;t.invariant(e.historyRoot);const[r]=e.historyRoot(),o={};return t.assign(o,{historyNode:r,runtimeNode:null,runtimeRoot:null,stateRef:e}),o})),u=l.run,a={Run:u,addNodeToHistory:p,createRef:function(e,n){return Object.freeze({Bus:t.bus.createBus(),Reconciler:e,appData:t.optionalFunctionValue(n),historyRoot:t.tinyState.createTinyState(null)})},persist:c,reset:function(){const[,,t]=f();t()},useAvailableRoot:function(){const t=E();if(t)return t;const[e]=f();return e},useCurrentCursor:function(){const t=v();return t?i.cursor(t):0},useHistoryRoot:f,useLoadRootNode:function(t){N(t)},useXAppData:function(){return d().stateRef.appData}};function c(t){const e=l.useX();return(...n)=>{var r;const o=null!==(r=l.use())&&void 0!==r?r:e;return l.run(o.stateRef,(()=>t(...n)))}}function d(){return l.useX()}function f(){return d().stateRef.historyRoot()}function y(){return d().historyNode}function h(){const t=v(),e=y();return t?i.at(e,i.cursor(t)):e}function p(e){const n=v();n?function(e){const n=v();t.invariant(n,o.NO_ACTIVE_ISOLATE),s.addChild(n,e)}(e):N(e),s.setParent(e,n)}function N(t){const[,e]=f();e(t)}function v(){var t;return null!==(t=d().runtimeNode)&&void 0!==t?t:null}function E(){return d().runtimeRoot}function O(){return d().stateRef.Bus}function I(e,n){const r=O().emit;return t.isNullish(e)||r(e,n),c(r)}var _,T=Object.freeze({__proto__:null,useBus:O,useEmit:I,usePrepareEmitter:function(t){const e=I();return n=>e(t,n)}});!function(t){t.Type="$type",t.Keys="keys",t.Key="key",t.Parent="parent",t.Data="data",t.AllowReorder="allowReorder",t.Status="status",t.AbortController="abortController",t.Children="children"}(_||(_={}));const R=new Set([_.AbortController,_.Parent,_.Keys]);function A(t,e){return(null==t?void 0:t[_.Type])===e}function S(t,e){return A(t,e[_.Type])}var b=Object.freeze({__proto__:null,isIsolateType:A,isSameIsolateIdentity:function(t,e){return Object.is(t,e)||S(t,e)&&t.key===e.key},isSameIsolateType:S});class C{static reconcile(e){const n=function(e,n){var r;if(t.isNullish(n))return function(t){if(i.usesKey(t))return C.handleIsolateNodeWithKey(t,!1);return t}(e);if(!S(e,n))return e;const o=d().stateRef.Reconciler;return null!==(r=o(e,n))&&void 0!==r?r:function(e,n){return t.isNullish(n),e}(e,n)}(e,h());return t.invariant(n,o.UNABLE_TO_PICK_NEXT_ISOLATE),n}static dropNextNodesOnReorder(t,e,n){const r=t(e,n);return r&&function(){const t=v(),e=y();if(!e||!t)return;s.slice(e,i.cursor(t))}(),r}static handleIsolateNodeWithKey(e,n){t.invariant(i.usesKey(e));const r=function(e){if(t.isNullish(e))return null;const n=d().historyNode;return i.getChildByKey(n,e)}(e.key);let l=e;return t.isNullish(r)||t.optionalFunctionValue(n,r)||(l=r),function(e,n){if(!e)return;const r=v();t.invariant(r,o.NO_ACTIVE_ISOLATE),t.isNullish(i.getChildByKey(r,e))?s.addChildKey(r,e,n):t.deferThrow(t.text(o.ENCOUNTERED_THE_SAME_KEY_TWICE,{key:e}))}(e.key,l),l}}class m{static create(e,n,o,i){const l=v(),a=s.setParent(function(t,e,n=null){const r=null!=e?e:{},{allowReorder:o,status:i}=r,s=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(n[r[o]]=t[r[o]])}return n}(r,["allowReorder","status"]);return Object.assign(Object.assign({[_.AllowReorder]:o,[_.AbortController]:new AbortController,[_.Keys]:null,[_.Parent]:null,[_.Type]:t,[_.Data]:s},i&&{[_.Status]:i}),{children:null,key:n,output:null})}(e,o,i),l),c=C.reconcile(a),d=h(),f=Object.is(c,a);p(c);const y=f?function(e,n,o){const i=E(),l=I(),a=u(Object.assign({historyNode:e,runtimeNode:n},!i&&{runtimeRoot:n}),(()=>{l(r.ISOLATE_ENTER,n);const e=o(n);return t.isPromise(e)?(l(r.ISOLATE_PENDING,n),e.then((t=>{m.isIsolate(t)&&s.addChild(n,t),l(r.ISOLATE_DONE,n)}))):l(r.ISOLATE_DONE,n),e}));return n.output=a,a}(d,a,n):c.output;return s.saveOutput(c,y),c}static isIsolate(e){return t.isNotNullish(e)&&e[_.Type]}}function k(e,n,r){if(t.isNullish(e.children))return;let o=!1;for(const s of e.children){if(o)return;if((t.isNullish(r)||t.optionalFunctionValue(r,s))&&n(s,i),o)return;k(s,((t,e)=>{n(t,(()=>{e(),i()}))}),r)}function i(){o=!0}}function L(t,e,n){let r=!1;return k(t,((t,n)=>{e(t)&&(n(),r=!0)}),n),r}function P(t,e){let n=t;do{if(e(n))return n;n=n.parent}while(n);return null}var w=Object.freeze({__proto__:null,closest:P,closestExists:function(t,e){return!!P(t,e)},every:function(t,e,n){let r=!0;return k(t,((t,n)=>{e(t)||(n(),r=!1)}),n),r},find:function(t,e,n){let r=null;return k(t,((t,n)=>{e(t)&&(n(),r=t)}),n),r},findClosest:function(t,e){var n,r;let o=null,i=t;for(;i&&(o=null!==(r=null===(n=i.children)||void 0===n?void 0:n.find(e))&&void 0!==r?r:null,!o);)i=i.parent;return o},has:function(t,e){return L(t,(()=>!0),e)},pluck:function(t,e,n){k(t,(t=>{e(t)&&t.parent&&s.removeChild(t.parent,t)}),n)},some:L,walk:k});class g{static deserialize(e){const r=t.isStringValue(e)?JSON.parse(e):Object.assign({},e),o=n.expandObject(...r);g.validateIsolate(o);const i=[o];for(;i.length;){const t=i.shift();if(!t)continue;const e=t.children;e&&(t.children=e.map((e=>{var n;const r=Object.assign({},e);s.setParent(r,t),i.push(r);const o=r.key;return o&&(t.keys=null!==(n=t.keys)&&void 0!==n?n:{},t.keys[o]=r),r})))}return o}static serialize(e){if(t.isNullish(e))return"";const r=n.minifyObject(e,R);return JSON.stringify(r)}static validateIsolate(e){t.invariant(t.hasOwnProperty(e,_.Type),t.text(o.INVALID_ISOLATE_CANNOT_PARSE))}}exports.Bus=T,exports.Isolate=m,exports.IsolateInspector=i,exports.IsolateMutator=s,exports.IsolateSelectors=b,exports.IsolateSerializer=g,exports.Reconciler=C,exports.RuntimeEvents=r,exports.VestRuntime=a,exports.Walker=w;
//# sourceMappingURL=vestjs-runtime.production.js.map
