!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vest-utils"),require("context"),require("vest-utils/minifyObject")):"function"==typeof define&&define.amd?define(["exports","vest-utils","context","vest-utils/minifyObject"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["vestjs-runtime"]={},t["vest-utils"],t.context,t.minifyObject)}(this,(function(t,e,n,r){"use strict";const i={ISOLATE_ENTER:"ISOLATE_ENTER",ISOLATE_PENDING:"ISOLATE_PENDING",ISOLATE_DONE:"ISOLATE_DONE"};var o;"function"==typeof SuppressedError&&SuppressedError,function(t){t.NO_ACTIVE_ISOLATE="Not within an active isolate",t.UNABLE_TO_PICK_NEXT_ISOLATE="Unable to pick next isolate. This is a bug, please report it to the Vest maintainers.",t.ENCOUNTERED_THE_SAME_KEY_TWICE='Encountered the same key "{key}" twice. This may lead to inconsistent or overriding of results.',t.INVALID_ISOLATE_CANNOT_PARSE="Invalid isolate was passed to IsolateSerializer. Cannot proceed."}(o||(o={}));class s{static at(t,n){var r,i;return e.isNullish(t)?null:null!==(i=null===(r=t.children)||void 0===r?void 0:r[n])&&void 0!==i?i:null}static cursor(t){var n,r;return e.isNullish(t)?0:null!==(r=null===(n=t.children)||void 0===n?void 0:n.length)&&void 0!==r?r:0}static canReorder(t){return!e.isNullish(t)&&s.allowsReorder(t.parent)}static allowsReorder(t){return!0===(null==t?void 0:t.allowReorder)}static usesKey(t){return!e.isNullish(t)&&e.isNotNullish(t.key)}static getChildByKey(t,n){var r,i;return e.isNullish(t)?null:null!==(i=null===(r=t.keys)||void 0===r?void 0:r[n])&&void 0!==i?i:null}}class l{static setParent(t,e){return t.parent=e,t}static saveOutput(t,e){return t.output=e,t}static setKey(t,e){return t.key=e,t}static addChild(t,n){var r;e.invariant(t),t.children=null!==(r=t.children)&&void 0!==r?r:[],t.children.push(n),l.setParent(n,t)}static removeChild(t,e){var n,r;t.children=null!==(r=null===(n=t.children)||void 0===n?void 0:n.filter((t=>t!==e)))&&void 0!==r?r:null}static addChildKey(t,n,r){var i;e.invariant(t),t.keys=null!==(i=t.keys)&&void 0!==i?i:{},t.keys[n]=r}static slice(t,n){e.isNullish(t.children)||(t.children.length=n)}static setData(t,e){t.data=e}static abort(t,n){e.isNullish(t.abortController)||t.abortController.abort(n)}}const u=n.createCascade(((t,n)=>{if(n)return null;e.invariant(t.historyRoot);const[r]=t.historyRoot(),i={};return e.assign(i,{historyNode:r,runtimeNode:null,runtimeRoot:null,stateRef:t}),i})),a=u.run,c={Run:a,addNodeToHistory:v,createRef:function(t,n){return Object.freeze({Bus:e.bus.createBus(),Reconciler:t,appData:e.optionalFunctionValue(n),historyRoot:e.tinyState.createTinyState(null)})},persist:d,reset:function(){const[,,t]=y();t()},useAvailableRoot:function(){const t=O();if(t)return t;const[e]=y();return e},useCurrentCursor:function(){const t=E();return t?s.cursor(t):0},useHistoryRoot:y,useLoadRootNode:function(t){N(t)},useXAppData:function(){return f().stateRef.appData}};function d(t){const e=u.useX();return(...n)=>{var r;const i=null!==(r=u.use())&&void 0!==r?r:e;return u.run(i.stateRef,(()=>t(...n)))}}function f(){return u.useX()}function y(){return f().stateRef.historyRoot()}function h(){return f().historyNode}function p(){const t=E(),e=h();return t?s.at(e,s.cursor(t)):e}function v(t){const n=E();n?function(t){const n=E();e.invariant(n,o.NO_ACTIVE_ISOLATE),l.addChild(n,t)}(t):N(t),l.setParent(t,n)}function N(t){const[,e]=y();e(t)}function E(){var t;return null!==(t=f().runtimeNode)&&void 0!==t?t:null}function O(){return f().runtimeRoot}function I(){return f().stateRef.Bus}function T(t,n){const r=I().emit;return e.isNullish(t)||r(t,n),d(r)}var _,R=Object.freeze({__proto__:null,useBus:I,useEmit:T,usePrepareEmitter:function(t){const e=T();return n=>e(t,n)}});!function(t){t.Type="$type",t.Keys="keys",t.Key="key",t.Parent="parent",t.Data="data",t.AllowReorder="allowReorder",t.Status="status",t.AbortController="abortController",t.Children="children"}(_||(_={}));const b=new Set([_.AbortController,_.Parent,_.Keys]);function A(t,e){return(null==t?void 0:t[_.Type])===e}function S(t,e){return A(t,e[_.Type])}var C=Object.freeze({__proto__:null,isIsolateType:A,isSameIsolateIdentity:function(t,e){return Object.is(t,e)||S(t,e)&&t.key===e.key},isSameIsolateType:S});class m{static reconcile(t){const n=function(t,n){var r;if(e.isNullish(n))return function(t){if(s.usesKey(t))return m.handleIsolateNodeWithKey(t,!1);return t}(t);if(!S(t,n))return t;const i=f().stateRef.Reconciler;return null!==(r=i(t,n))&&void 0!==r?r:function(t,n){return e.isNullish(n),t}(t,n)}(t,p());return e.invariant(n,o.UNABLE_TO_PICK_NEXT_ISOLATE),n}static dropNextNodesOnReorder(t,e,n){const r=t(e,n);return r&&function(){const t=E(),e=h();if(!e||!t)return;l.slice(e,s.cursor(t))}(),r}static handleIsolateNodeWithKey(t,n){e.invariant(s.usesKey(t));const r=function(t){if(e.isNullish(t))return null;const n=f().historyNode;return s.getChildByKey(n,t)}(t.key);let i=t;return e.isNullish(r)||e.optionalFunctionValue(n,r)||(i=r),function(t,n){if(!t)return;const r=E();e.invariant(r,o.NO_ACTIVE_ISOLATE),e.isNullish(s.getChildByKey(r,t))?l.addChildKey(r,t,n):e.deferThrow(e.text(o.ENCOUNTERED_THE_SAME_KEY_TWICE,{key:t}))}(t.key,i),i}}class k{static create(t,n,r,o){const s=E(),u=l.setParent(function(t,e,n=null){const r=null!=e?e:{},{allowReorder:i,status:o}=r,s=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]])}return n}(r,["allowReorder","status"]);return Object.assign(Object.assign({[_.AllowReorder]:i,[_.AbortController]:new AbortController,[_.Keys]:null,[_.Parent]:null,[_.Type]:t,[_.Data]:s},o&&{[_.Status]:o}),{children:null,key:n,output:null})}(t,r,o),s),c=m.reconcile(u),d=p(),f=Object.is(c,u);v(c);const y=f?function(t,n,r){const o=O(),s=T(),u=a(Object.assign({historyNode:t,runtimeNode:n},!o&&{runtimeRoot:n}),(()=>{s(i.ISOLATE_ENTER,n);const t=r(n);return e.isPromise(t)?(s(i.ISOLATE_PENDING,n),t.then((t=>{k.isIsolate(t)&&l.addChild(n,t),s(i.ISOLATE_DONE,n)}))):s(i.ISOLATE_DONE,n),t}));return n.output=u,u}(d,u,n):c.output;return l.saveOutput(c,y),c}static isIsolate(t){return e.isNotNullish(t)&&t[_.Type]}}function j(t,n,r){if(e.isNullish(t.children))return;let i=!1;for(const s of t.children){if(i)return;if((e.isNullish(r)||e.optionalFunctionValue(r,s))&&n(s,o),i)return;j(s,((t,e)=>{n(t,(()=>{e(),o()}))}),r)}function o(){i=!0}}function L(t,e,n){let r=!1;return j(t,((t,n)=>{e(t)&&(n(),r=!0)}),n),r}function g(t,e){let n=t;do{if(e(n))return n;n=n.parent}while(n);return null}var P=Object.freeze({__proto__:null,closest:g,closestExists:function(t,e){return!!g(t,e)},every:function(t,e,n){let r=!0;return j(t,((t,n)=>{e(t)||(n(),r=!1)}),n),r},find:function(t,e,n){let r=null;return j(t,((t,n)=>{e(t)&&(n(),r=t)}),n),r},findClosest:function(t,e){var n,r;let i=null,o=t;for(;o&&(i=null!==(r=null===(n=o.children)||void 0===n?void 0:n.find(e))&&void 0!==r?r:null,!i);)o=o.parent;return i},has:function(t,e){return L(t,(()=>!0),e)},pluck:function(t,e,n){j(t,(t=>{e(t)&&t.parent&&l.removeChild(t.parent,t)}),n)},some:L,walk:j});class w{static deserialize(t){const n=e.isStringValue(t)?JSON.parse(t):Object.assign({},t),i=r.expandObject(...n);w.validateIsolate(i);const o=[i];for(;o.length;){const t=o.shift();if(!t)continue;const e=t.children;e&&(t.children=e.map((e=>{var n;const r=Object.assign({},e);l.setParent(r,t),o.push(r);const i=r.key;return i&&(t.keys=null!==(n=t.keys)&&void 0!==n?n:{},t.keys[i]=r),r})))}return i}static serialize(t){if(e.isNullish(t))return"";const n=r.minifyObject(t,b);return JSON.stringify(n)}static validateIsolate(t){e.invariant(e.hasOwnProperty(t,_.Type),e.text(o.INVALID_ISOLATE_CANNOT_PARSE))}}t.Bus=R,t.Isolate=k,t.IsolateInspector=s,t.IsolateMutator=l,t.IsolateSelectors=C,t.IsolateSerializer=w,t.Reconciler=m,t.RuntimeEvents=i,t.VestRuntime=c,t.Walker=P}));
//# sourceMappingURL=vestjs-runtime.production.js.map
