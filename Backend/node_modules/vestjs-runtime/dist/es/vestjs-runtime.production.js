import{isNullish as t,isNotNullish as e,invariant as n,assign as r,bus as o,optionalFunctionValue as i,tinyState as s,deferThrow as u,text as l,isPromise as a,isStringValue as c,hasOwnProperty as d}from"vest-utils";import{createCascade as f}from"context";import{expandObject as y,minifyObject as p}from"vest-utils/minifyObject";const E={ISOLATE_ENTER:"ISOLATE_ENTER",ISOLATE_PENDING:"ISOLATE_PENDING",ISOLATE_DONE:"ISOLATE_DONE"};var O;"function"==typeof SuppressedError&&SuppressedError,function(t){t.NO_ACTIVE_ISOLATE="Not within an active isolate",t.UNABLE_TO_PICK_NEXT_ISOLATE="Unable to pick next isolate. This is a bug, please report it to the Vest maintainers.",t.ENCOUNTERED_THE_SAME_KEY_TWICE='Encountered the same key "{key}" twice. This may lead to inconsistent or overriding of results.',t.INVALID_ISOLATE_CANNOT_PARSE="Invalid isolate was passed to IsolateSerializer. Cannot proceed."}(O||(O={}));class h{static at(e,n){var r,o;return t(e)?null:null!==(o=null===(r=e.children)||void 0===r?void 0:r[n])&&void 0!==o?o:null}static cursor(e){var n,r;return t(e)?0:null!==(r=null===(n=e.children)||void 0===n?void 0:n.length)&&void 0!==r?r:0}static canReorder(e){return!t(e)&&h.allowsReorder(e.parent)}static allowsReorder(t){return!0===(null==t?void 0:t.allowReorder)}static usesKey(n){return!t(n)&&e(n.key)}static getChildByKey(e,n){var r,o;return t(e)?null:null!==(o=null===(r=e.keys)||void 0===r?void 0:r[n])&&void 0!==o?o:null}}class v{static setParent(t,e){return t.parent=e,t}static saveOutput(t,e){return t.output=e,t}static setKey(t,e){return t.key=e,t}static addChild(t,e){var r;n(t),t.children=null!==(r=t.children)&&void 0!==r?r:[],t.children.push(e),v.setParent(e,t)}static removeChild(t,e){var n,r;t.children=null!==(r=null===(n=t.children)||void 0===n?void 0:n.filter((t=>t!==e)))&&void 0!==r?r:null}static addChildKey(t,e,r){var o;n(t),t.keys=null!==(o=t.keys)&&void 0!==o?o:{},t.keys[e]=r}static slice(e,n){t(e.children)||(e.children.length=n)}static setData(t,e){t.data=e}static abort(e,n){t(e.abortController)||e.abortController.abort(n)}}const _=f(((t,e)=>{if(e)return null;n(t.historyRoot);const[o]=t.historyRoot(),i={};return r(i,{historyNode:o,runtimeNode:null,runtimeRoot:null,stateRef:t}),i})),T=_.run,N={Run:T,addNodeToHistory:b,createRef:function(t,e){return Object.freeze({Bus:o.createBus(),Reconciler:t,appData:i(e),historyRoot:s.createTinyState(null)})},persist:I,reset:function(){const[,,t]=R();t()},useAvailableRoot:function(){const t=L();if(t)return t;const[e]=R();return e},useCurrentCursor:function(){const t=k();return t?h.cursor(t):0},useHistoryRoot:R,useLoadRootNode:function(t){m(t)},useXAppData:function(){return A().stateRef.appData}};function I(t){const e=_.useX();return(...n)=>{var r;const o=null!==(r=_.use())&&void 0!==r?r:e;return _.run(o.stateRef,(()=>t(...n)))}}function A(){return _.useX()}function R(){return A().stateRef.historyRoot()}function S(){return A().historyNode}function C(){const t=k(),e=S();return t?h.at(e,h.cursor(t)):e}function b(t){const e=k();e?function(t){const e=k();n(e,O.NO_ACTIVE_ISOLATE),v.addChild(e,t)}(t):m(t),v.setParent(t,e)}function m(t){const[,e]=R();e(t)}function k(){var t;return null!==(t=A().runtimeNode)&&void 0!==t?t:null}function L(){return A().runtimeRoot}function K(){return A().stateRef.Bus}function P(e,n){const r=K().emit;return t(e)||r(e,n),I(r)}var w,g=Object.freeze({__proto__:null,useBus:K,useEmit:P,usePrepareEmitter:function(t){const e=P();return n=>e(t,n)}});!function(t){t.Type="$type",t.Keys="keys",t.Key="key",t.Parent="parent",t.Data="data",t.AllowReorder="allowReorder",t.Status="status",t.AbortController="abortController",t.Children="children"}(w||(w={}));const D=new Set([w.AbortController,w.Parent,w.Keys]);function j(t,e){return(null==t?void 0:t[w.Type])===e}function B(t,e){return j(t,e[w.Type])}var x=Object.freeze({__proto__:null,isIsolateType:j,isSameIsolateIdentity:function(t,e){return Object.is(t,e)||B(t,e)&&t.key===e.key},isSameIsolateType:B});class z{static reconcile(e){const r=function(e,n){var r;if(t(n))return function(t){if(h.usesKey(t))return z.handleIsolateNodeWithKey(t,!1);return t}(e);if(!B(e,n))return e;const o=A().stateRef.Reconciler;return null!==(r=o(e,n))&&void 0!==r?r:function(e,n){return t(n),e}(e,n)}(e,C());return n(r,O.UNABLE_TO_PICK_NEXT_ISOLATE),r}static dropNextNodesOnReorder(t,e,n){const r=t(e,n);return r&&function(){const t=k(),e=S();if(!e||!t)return;v.slice(e,h.cursor(t))}(),r}static handleIsolateNodeWithKey(e,r){n(h.usesKey(e));const o=function(e){if(t(e))return null;const n=A().historyNode;return h.getChildByKey(n,e)}(e.key);let s=e;return t(o)||i(r,o)||(s=o),function(e,r){if(!e)return;const o=k();n(o,O.NO_ACTIVE_ISOLATE),t(h.getChildByKey(o,e))?v.addChildKey(o,e,r):u(l(O.ENCOUNTERED_THE_SAME_KEY_TWICE,{key:e}))}(e.key,s),s}}class V{static create(t,e,n,r){const o=k(),i=v.setParent(function(t,e,n=null){const r=null!=e?e:{},{allowReorder:o,status:i}=r,s=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(n[r[o]]=t[r[o]])}return n}(r,["allowReorder","status"]);return Object.assign(Object.assign({[w.AllowReorder]:o,[w.AbortController]:new AbortController,[w.Keys]:null,[w.Parent]:null,[w.Type]:t,[w.Data]:s},i&&{[w.Status]:i}),{children:null,key:n,output:null})}(t,n,r),o),s=z.reconcile(i),u=C(),l=Object.is(s,i);b(s);const c=l?function(t,e,n){const r=L(),o=P(),i=T(Object.assign({historyNode:t,runtimeNode:e},!r&&{runtimeRoot:e}),(()=>{o(E.ISOLATE_ENTER,e);const t=n(e);return a(t)?(o(E.ISOLATE_PENDING,e),t.then((t=>{V.isIsolate(t)&&v.addChild(e,t),o(E.ISOLATE_DONE,e)}))):o(E.ISOLATE_DONE,e),t}));return e.output=i,i}(u,i,e):s.output;return v.saveOutput(s,c),s}static isIsolate(t){return e(t)&&t[w.Type]}}function U(e,n,r){if(t(e.children))return;let o=!1;for(const u of e.children){if(o)return;if((t(r)||i(r,u))&&n(u,s),o)return;U(u,((t,e)=>{n(t,(()=>{e(),s()}))}),r)}function s(){o=!0}}function W(t,e,n){let r=!1;return U(t,((t,n)=>{e(t)&&(n(),r=!0)}),n),r}function X(t,e){let n=t;do{if(e(n))return n;n=n.parent}while(n);return null}var H=Object.freeze({__proto__:null,closest:X,closestExists:function(t,e){return!!X(t,e)},every:function(t,e,n){let r=!0;return U(t,((t,n)=>{e(t)||(n(),r=!1)}),n),r},find:function(t,e,n){let r=null;return U(t,((t,n)=>{e(t)&&(n(),r=t)}),n),r},findClosest:function(t,e){var n,r;let o=null,i=t;for(;i&&(o=null!==(r=null===(n=i.children)||void 0===n?void 0:n.find(e))&&void 0!==r?r:null,!o);)i=i.parent;return o},has:function(t,e){return W(t,(()=>!0),e)},pluck:function(t,e,n){U(t,(t=>{e(t)&&t.parent&&v.removeChild(t.parent,t)}),n)},some:W,walk:U});class G{static deserialize(t){const e=c(t)?JSON.parse(t):Object.assign({},t),n=y(...e);G.validateIsolate(n);const r=[n];for(;r.length;){const t=r.shift();if(!t)continue;const e=t.children;e&&(t.children=e.map((e=>{var n;const o=Object.assign({},e);v.setParent(o,t),r.push(o);const i=o.key;return i&&(t.keys=null!==(n=t.keys)&&void 0!==n?n:{},t.keys[i]=o),o})))}return n}static serialize(e){if(t(e))return"";const n=p(e,D);return JSON.stringify(n)}static validateIsolate(t){n(d(t,w.Type),l(O.INVALID_ISOLATE_CANNOT_PARSE))}}export{g as Bus,V as Isolate,h as IsolateInspector,v as IsolateMutator,x as IsolateSelectors,G as IsolateSerializer,z as Reconciler,E as RuntimeEvents,N as VestRuntime,H as Walker};
//# sourceMappingURL=vestjs-runtime.production.js.map
