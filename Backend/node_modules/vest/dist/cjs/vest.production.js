"use strict";var t=require("n4s"),e=require("vest-utils"),n=require("vestjs-runtime"),s=require("context");const i="Each",r="Focused",a="Group",o="OmitWhen",u="SkipWhen",c="Suite",l="Test";class E{static setOptionalField(t,n,s){const i=t.data.optional,r=i[n];e.assign(i,{[n]:e.assign({},r,s(r))})}static getOptionalField(t,e){var n;return null!==(n=E.getOptionalFields(t)[e])&&void 0!==n?n:{}}static getOptionalFields(t){var e,n;return null!==(n=null===(e=t.data)||void 0===e?void 0:e.optional)&&void 0!==n?n:{}}}var d,f;!function(t){t[t.CUSTOM_LOGIC=0]="CUSTOM_LOGIC",t[t.AUTO=1]="AUTO"}(d||(d={})),exports.Modes=void 0,(f=exports.Modes||(exports.Modes={})).EAGER="EAGER",f.ALL="ALL",f.ONE="ONE";const N=s.createCascade(((t,n)=>n?null:e.assign({inclusion:{},mode:e.tinyState.createTinyState(exports.Modes.EAGER),suiteParams:[],testMemoCache:S},t)));function T(){return N.useX().inclusion}function g(){return N.useX().mode()}const S=e.cache(10);function R(s){var i;const r=n.VestRuntime.useAvailableRoot(),a=N.useX().suiteParams,o=null!==(i=null==a?void 0:a[0])&&void 0!==i?i:{};if(e.isArray(s)||e.isStringValue(s))e.asArray(s).forEach((n=>{E.setOptionalField(r,n,(()=>({type:d.AUTO,applied:!!e.hasOwnProperty(o,n)&&t.enforce.isBlank().test(null==o?void 0:o[n]),rule:null})))}));else for(const e in s){const n=s[e];E.setOptionalField(r,e,(()=>({type:d.CUSTOM_LOGIC,rule:n,applied:t.enforce.isBlank().test(n)||!0===n})))}}function I(t){var e,s;if(!t)return!1;const i=n.VestRuntime.useAvailableRoot();return null!==(s=null===(e=E.getOptionalField(i,t))||void 0===e?void 0:e.applied)&&void 0!==s&&s}var p;!function(t){t.HOOK_CALLED_OUTSIDE="hook called outside of a running suite.",t.EXPECTED_VEST_TEST="Expected value to be an instance of IsolateTest",t.FIELD_NAME_REQUIRED="Field name must be passed",t.SUITE_MUST_BE_INITIALIZED_WITH_FUNCTION="Suite must be initialized with a function",t.PROMISIFY_REQUIRE_FUNCTION="Vest.Promisify must be called with a function",t.PARSER_EXPECT_RESULT_OBJECT="Vest parser: expected argument at position 0 to be Vest's result object.",t.WARN_MUST_BE_CALLED_FROM_TEST="Warn must be called from within the body of a test function",t.EACH_CALLBACK_MUST_BE_A_FUNCTION="Each must be called with a function",t.INVALID_PARAM_PASSED_TO_FUNCTION='Incompatible params passed to {fn_name} function. "{param}" must be of type {expected}',t.TESTS_CALLED_IN_DIFFERENT_ORDER='Vest Critical Error: Tests called in different order than previous run.\n    expected: {fieldName}\n    received: {prevName}\n    This can happen on one of two reasons:\n    1. You\'re using if/else statements to conditionally select tests. Instead, use "skipWhen".\n    2. You are iterating over a list of tests, and their order changed. Use "each" and a custom key prop so that Vest retains their state.',t.UNEXPECTED_TEST_REGISTRATION_ERROR="Unexpected error encountered during test registration.\n      Please report this issue to Vest's Github repository.\n      Test Object: {testObject}.\n      Error: {error}.",t.UNEXPECTED_TEST_RUN_ERROR="Unexpected error encountered during test run. Please report this issue to Vest's Github repository.\n      Test Object: {testObject}.",t.INCLUDE_SELF="Trying to call include.when on the same field."}(p||(p={}));const m="PENDING",_="INITIAL",O={[m]:m,[_]:_,DONE:"DONE"},D={initial:O.INITIAL,states:{[O.DONE]:{},[O.INITIAL]:{[O.PENDING]:O.PENDING,[O.DONE]:O.DONE},[O.PENDING]:{[O.DONE]:O.DONE}}};function A(t,e){return v.staticTransition(null!=t?t:O.INITIAL,e)}const v=e.StateMachine(D),h={[m]:m,CANCELED:"CANCELED",FAILED:"FAILED",OMITTED:"OMITTED",PASSING:"PASSING",SKIPPED:"SKIPPED",UNTESTED:"UNTESTED",WARNING:"WARNING"},C="RESET",P={initial:h.UNTESTED,states:{"*":{[h.OMITTED]:h.OMITTED,[C]:h.UNTESTED},[h.UNTESTED]:{[h.CANCELED]:h.CANCELED,[h.FAILED]:h.FAILED,[h.PASSING]:h.PASSING,[h.PENDING]:h.PENDING,[h.SKIPPED]:h.SKIPPED,[h.WARNING]:h.WARNING},[h.PENDING]:{[h.CANCELED]:h.CANCELED,[h.FAILED]:h.FAILED,[h.PASSING]:h.PASSING,[h.SKIPPED]:[h.SKIPPED,t=>!0===t],[h.WARNING]:h.WARNING},[h.SKIPPED]:{},[h.FAILED]:{},[h.WARNING]:{},[h.PASSING]:{},[h.CANCELED]:{},[h.OMITTED]:{}}},F=e.StateMachine(P);var L,U,y,W;function G(t){return t===L.ERRORS?U.ERROR_COUNT:U.WARN_COUNT}!function(t){t.WARNINGS="warnings",t.ERRORS="errors"}(L||(L={})),function(t){t.ERROR_COUNT="errorCount",t.WARN_COUNT="warnCount"}(U||(U={})),function(t){t.Error="error",t.Warning="warning"}(y||(y={}));class b{static getStatus(t){var e;return null!==(e=t.status)&&void 0!==e?e:_}static setStatus(t,e,n){t.status=this.stateMachine.staticTransition(b.getStatus(t),e,n)}static statusEquals(t,e){return b.getStatus(t)===e}static setPending(t){this.setStatus(t,m)}static isPending(t){return b.statusEquals(t,m)}}b.stateMachine=v;class V extends b{static getData(t){return e.invariant(t.data),t.data}static is(t){return n.IsolateSelectors.isIsolateType(t,l)}static isX(t){e.invariant(V.is(t),p.EXPECTED_VEST_TEST)}static cast(t){return V.isX(t),t}static warns(t){return V.getData(t).severity===y.Warning}static isOmitted(t){return V.statusEquals(t,h.OMITTED)}static isUntested(t){return V.statusEquals(t,h.UNTESTED)}static isFailing(t){return V.statusEquals(t,h.FAILED)}static isCanceled(t){return V.statusEquals(t,h.CANCELED)}static isSkipped(t){return V.statusEquals(t,h.SKIPPED)}static isPassing(t){return V.statusEquals(t,h.PASSING)}static isWarning(t){return V.statusEquals(t,h.WARNING)}static hasFailures(t){return V.isFailing(t)||V.isWarning(t)}static isNonActionable(t){return V.isSkipped(t)||V.isOmitted(t)||V.isCanceled(t)}static isTested(t){return V.hasFailures(t)||V.isPassing(t)}static awaitsResolution(t){return V.isSkipped(t)||V.isUntested(t)||V.isPending(t)}static isAsyncTest(t){return e.isPromise(V.getData(t).asyncTest)}static fail(t){V.setStatus(t,V.warns(t)?h.WARNING:h.FAILED)}static pass(t){V.setStatus(t,h.PASSING)}static warn(t){V.setData(t,(t=>Object.assign(Object.assign({},t),{severity:y.Warning})))}static setData(t,n){t.data=e.optionalFunctionValue(n,V.getData(t))}static skip(t,e){V.setStatus(t,h.SKIPPED,e)}static cancel(t){V.setStatus(t,h.CANCELED),n.IsolateMutator.abort(t,h.CANCELED)}static omit(t){V.setStatus(t,h.OMITTED)}static reset(t){V.setStatus(t,C)}}function M(t,e){return!!e&&!k(t,e)}function k(t,e){return!(!e||t.fieldName!==e)}function B(t,e){const{groupName:n}=V.getData(t),{groupName:s,fieldName:i}=V.getData(e);return k(V.getData(t),i)&&n===s&&t.key==e.key}function w(t,s){return n.Isolate.create(r,e.noop,{focusMode:t,match:e.asArray(s).filter(e.isStringValue),matchAll:!0===s})}V.stateMachine=F,function(t){t[t.ONLY=0]="ONLY",t[t.SKIP=1]="SKIP"}(W||(W={}));class x{static isSkipFocused(t,e){return(null==t?void 0:t.data.focusMode)===W.SKIP&&(q(t,e)||!0===t.data.matchAll)}static isOnlyFocused(t,e){return(null==t?void 0:t.data.focusMode)===W.ONLY&&q(t,e)}static isIsolateFocused(t){return n.IsolateSelectors.isIsolateType(t,r)}}function j(t){return w(W.ONLY,X(t))}function K(t){return w(W.SKIP,X(t))}function X(t){return!1===t?[]:t}function q(t,n){var s,i;return e.isNotEmpty(null==t?void 0:t.data.match)&&(!n||(null===(i=null===(s=null==t?void 0:t.data.match)||void 0===s?void 0:s.includes(n))||void 0===i||i))}const H=e.cache();function Y(){return n.VestRuntime.useXAppData()}function z(){return Y().doneCallbacks()}function J(){return Y().fieldCallbacks()}function Q(){return Y().suiteId}function Z(){Y().suiteResultCache.invalidate([Q()])}function $(){const[,,t]=z(),[,,e]=J();t(),e()}function tt(t){n.VestRuntime.useLoadRootNode(t),Z()}function et(t,n,s){return s?function(t,e,n){var s;return(null===(s=null==t?void 0:t[n])||void 0===s?void 0:s[e])||[]}(t,n,s):function(t,n){const s={},i=G(n);for(const r in t)e.isPositive(t[r][i])&&(s[r]=t[r][n]||[]);return s}(t,n)}function nt(t){const n={getError:function(e){return ut(L.ERRORS,t,e)},getErrors:function(e){return st(t,L.ERRORS,e)},getErrorsByGroup:function(e,n){return it(t,L.ERRORS,e,n)},getWarning:function(e){return ut(L.WARNINGS,t,e)},getWarnings:function(e){return st(t,L.WARNINGS,e)},getWarningsByGroup:function(e,n){return it(t,L.WARNINGS,e,n)},hasErrors:function(e){return ot(t,U.ERROR_COUNT,e)},hasErrorsByGroup:function(e,n){return at(t,U.ERROR_COUNT,e,n)},hasWarnings:function(e){return ot(t,U.WARN_COUNT,e)},hasWarningsByGroup:function(e,n){return at(t,U.WARN_COUNT,e,n)},isPending:function(n){var s;return n?e.greaterThan(null===(s=t.tests[n])||void 0===s?void 0:s.pendingCount,0):e.greaterThan(t.pendingCount,0)},isTested:function(n){var s;return e.isPositive(null===(s=t.tests[n])||void 0===s?void 0:s.testCount)},isValid:function(e){var n;return e?Boolean(null===(n=t.tests[e])||void 0===n?void 0:n.valid):t.valid},isValidByGroup:function(e,n){const s=t.groups[e];if(!s)return!1;if(n)return rt(s,n);for(const t in s)if(!rt(s,t))return!1;return!0}};return n}function st(t,e,n){return et(t.tests,e,n)}function it(t,e,n,s){return et(t.groups[n],e,s)}function rt(t,e){var n;return!!(null===(n=t[e])||void 0===n?void 0:n.valid)}function at(t,n,s,i){var r,a;const o=t.groups[s];if(!o)return!1;if(i)return e.isPositive(null===(r=o[i])||void 0===r?void 0:r[n]);for(const t in o)if(e.isPositive(null===(a=o[t])||void 0===a?void 0:a[n]))return!0;return!1}function ot(t,n,s){var i;const r=s?null===(i=t.tests[s])||void 0===i?void 0:i[n]:t[n]||0;return e.isPositive(r)}function ut(t,e,n){var s;const i=e[t];return n?null===(s=i.find((t=>k(t,n))))||void 0===s?void 0:s.message:i[0]}var ct,lt;class Et{constructor(){this.errorCount=0,this.warnCount=0,this.testCount=0,this.pendingCount=0}}class dt extends Et{constructor(){super(...arguments),this[ct]=[],this[lt]=[],this.groups={},this.tests={},this.valid=!1}}ct=L.ERRORS,lt=L.WARNINGS;class ft{constructor(t,e,n){this.fieldName=t,this.message=e,this.groupName=n}static fromTestObject(t){const{fieldName:e,message:n,groupName:s}=V.getData(t);return new ft(e,n,s)}}class Nt{static hasNoTests(t=Nt.defaultRoot()){return!t||!n.Walker.has(t,V.is)}static someTests(t,e=Nt.defaultRoot()){return!!e&&n.Walker.some(e,(e=>(V.isX(e),t(e))),V.is)}static everyTest(t,e=Nt.defaultRoot()){return!!e&&n.Walker.every(e,(e=>(V.isX(e),t(e))),V.is)}static walkTests(t,e=Nt.defaultRoot()){e&&n.Walker.walk(e,((e,n)=>{t(V.cast(e),n)}),V.is)}static pluckTests(t,e=Nt.defaultRoot()){e&&n.Walker.pluck(e,(e=>(V.isX(e),t(e))),V.is)}static resetField(t){Nt.walkTests((e=>{k(V.getData(e),t)&&V.reset(e)}),Nt.defaultRoot())}static removeTestByFieldName(t,e=Nt.defaultRoot()){Nt.pluckTests((e=>k(V.getData(e),t)),e)}}Nt.defaultRoot=n.VestRuntime.useAvailableRoot;class Tt{static hasPending(t){const s=Tt.defaultRoot();return!!s&&n.Walker.some(s,e.Predicates.all(b.isPending,null==t||t))}static hasRemainingWithTestNameMatching(t){return Tt.hasPending(e.Predicates.any(e.isNullish(t),e.Predicates.all(V.is,(e=>function(t,e){return!e||k(t,e)}(V.getData(e),t)))))}}Tt.defaultRoot=n.VestRuntime.useAvailableRoot;const gt=e.bindNot((function(t,e){return V.getData(t).groupName===e}));function St(t){return function(t,e){return Nt.someTests((n=>Rt(n,t,e)))}(L.ERRORS,t)}function Rt(t,n,s){return!!V.hasFailures(t)&&(!M(V.getData(t),s)&&!function(t,n){return e.either(t===L.WARNINGS,V.warns(n))}(n,t))}function It(t){return!!I(t)||!Nt.hasNoTests()&&(!St(t)&&(!function(t){return Tt.hasPending(e.Predicates.all(V.is,(e=>!M(V.getData(e),t)),(()=>!I(t))))}(t)&&function(t){return Nt.everyTest((e=>mt(e,t)))}(t)))}function pt(t,n){return!!I(n)||!function(t,e,n){return Nt.someTests((s=>!gt(s,e)&&Rt(s,t,n)))}(L.ERRORS,t,n)&&(!function(t,n){return Tt.hasPending(e.Predicates.all(V.is,(e=>!gt(e,t)),(t=>!M(V.getData(t),n)),(()=>!I(n))))}(t,n)&&function(t,e){return Nt.everyTest((n=>!!gt(n,t)||mt(n,e)))}(t,n))}function mt(t,e){return!!M(V.getData(t),e)||(V.isOmitted(t)||V.isTested(t)||function(t){const e=n.VestRuntime.useAvailableRoot(),{fieldName:s}=V.getData(t);return E.getOptionalField(e,s).type===d.AUTO&&V.awaitsResolution(t)}(t))}function _t(){const t=new dt;return Nt.walkTests((e=>{t.tests=function(t,e){const n=V.getData(e).fieldName,s=Object.assign({},t);return s[n]=Dt(s[n],e),s[n].valid=!1!==s[n].valid&&It(n),s}(t.tests,e),t.groups=function(t,e){const{groupName:n,fieldName:s}=V.getData(e);if(!n)return t;const i=Object.assign({},t);return i[n]=i[n]||{},i[n][s]=Dt(i[n][s],e),i[n][s].valid=!1!==i[n][s].valid&&pt(n,s),i}(t.groups,e),t.errors=Ot(L.ERRORS,t.errors,e),t.warnings=Ot(L.WARNINGS,t.warnings,e)})),t.valid=It(),function(t){for(const e in t.tests)t.errorCount+=t.tests[e].errorCount,t.warnCount+=t.tests[e].warnCount,t.testCount+=t.tests[e].testCount,t.pendingCount+=t.tests[e].pendingCount;return t}(t)}function Ot(t,e,n){if(V.isOmitted(n))return e;return(t===L.WARNINGS?V.isWarning(n):V.isFailing(n))?e.concat(ft.fromTestObject(n)):e}function Dt(t,n){const{message:s}=V.getData(n),i=e.defaultTo(t?Object.assign({},t):null,At);return V.isNonActionable(n)||(V.isPending(n)&&i.pendingCount++,V.isFailing(n)?r(L.ERRORS):V.isWarning(n)&&r(L.WARNINGS),i.testCount++),i;function r(t){const e=G(t);i[e]++,s&&(i[t]=(i[t]||[]).concat(s))}}function At(){return e.assign(new Et,{errors:[],valid:!0,warnings:[]})}function vt(){return t=()=>{const t=_t(),n=Y().suiteName;return Object.freeze(e.assign(t,nt(t),{suiteName:n}))},(0,Y().suiteResultCache)([Q()],t);var t}function ht(t,s){n.Isolate.create(u,(()=>{N.run({skipped:Ct()||e.optionalFunctionValue(t,e.optionalFunctionValue(vt))},s)}))}function Ct(){return function(){var t;return null!==(t=N.useX().skipped)&&void 0!==t&&t}()}function Pt(t,s){return e.isNotNullish(n.Walker.findClosest(t,(t=>!!x.isIsolateFocused(t)&&x.isOnlyFocused(t,s))))}function Ft(t){const{fieldName:s}=V.getData(t);if(Ct())return!0;const i=T(),r=function(t){return n.Walker.findClosest(t,(e=>{var n;if(!x.isIsolateFocused(e))return!1;const{fieldName:s}=V.getData(t);return(null===(n=e.data.match)||void 0===n?void 0:n.includes(s))||e.data.matchAll}))}(t);if(x.isSkipFocused(r))return!0;return!x.isOnlyFocused(r)&&(!!Pt(t)&&!e.optionalFunctionValue(i[s],t))}function Lt(t){const[e]=g();return e===t}function Ut(t){return Lt(exports.Modes.ONE)?St():!!Lt(exports.Modes.EAGER)&&St(t.fieldName)}function yt(t,s){n.Isolate.create(o,(()=>{N.run({omitted:Wt()||e.optionalFunctionValue(t,e.optionalFunctionValue(vt))},s)}))}function Wt(){return function(){var t;return null!==(t=N.useX().omitted)&&void 0!==t&&t}()}function Gt(t,e=t){const n=V.getData(t);return Ut(n)?(s=t,V.skip(s),s):(i=n.fieldName,Wt()||I(i)?function(t){return V.omit(t),t}(t):Ft(t)?function(t){return V.skip(t,Ct()),t}(e):t);var s,i}function bt(t,e){return V.is(e)&&!B(e,t)}const Vt=[class{static match(t,e){return V.is(t)&&V.is(e)}static reconcile(t,s){const i=Gt(t,function(t,s){if(n.IsolateInspector.usesKey(t))return function(t){return V.cast(n.Reconciler.handleIsolateNodeWithKey(t,(e=>!!V.isNonActionable(e)||!Ft(t))))}(t);if(n.Reconciler.dropNextNodesOnReorder(bt,t,s))return function(t,s){if(n.IsolateInspector.canReorder(t))return;e.deferThrow(e.text(p.TESTS_CALLED_IN_DIFFERENT_ORDER,{fieldName:V.getData(t).fieldName,prevName:V.is(s)?V.getData(s).fieldName:void 0}))}(t,s),t;if(!V.is(s))return t;if(V.isOmitted(s))return t;return s}(t,s));return function(t,e,n){t===e&&V.is(e)&&(i=e)!==(s=n)&&B(s,i)&&V.isPending(s)&&V.cancel(s);var s,i}(i,t,s),i}}];function Mt(t,e){var n,s;return null!==(s=null===(n=Vt.find((n=>n.match(t,e))))||void 0===n?void 0:n.reconcile(t,e))&&void 0!==s?s:null}function kt(...t){const[e,s]=t.reverse();return n.Isolate.create(a,(()=>N.run(Object.assign({},s&&{groupName:s}),e)))}function Bt(t){e.invariant(e.isStringValue(t));return T()[t]=!0,{when:function(n){e.invariant(n!==t,p.INCLUDE_SELF);T()[t]=function(t){return e.isStringValue(n)?Pt(t,n):e.optionalFunctionValue(n,e.optionalFunctionValue(vt))}}}}var wt;function xt(t,e,s){const i=Object.assign(Object.assign({},{severity:y.Error,status:F.initial()}),{fieldName:e.fieldName,testFn:e.testFn});e.groupName&&(i.groupName=e.groupName),e.message&&(i.message=e.message);return n.Isolate.create(l,t,i,null!=s?s:null)}function jt(t){if(Gt(t),V.isUntested(t))return function(t){const s=function(t){return N.run({currentTest:t},(()=>{let n;const{message:s,testFn:i}=V.getData(t);try{n=i({signal:t.abortController.signal})}catch(i){(function(t,n){return e.isUndefined(t)&&e.isStringValue(n)})(s,i)&&(V.getData(t).message=i),n=!1}return!1===n&&V.fail(t),n}))}(t);try{if(e.isPromise(s))return V.getData(t).asyncTest=s,function(t){const{asyncTest:s,message:i}=V.getData(t);if(!e.isPromise(s))return;const r=n.VestRuntime.persist((()=>{Kt(t)})),a=n.VestRuntime.persist((n=>{V.isCanceled(t)||(V.getData(t).message=e.isStringValue(n)?n:i,V.fail(t),r())}));return s.then(r,a)}(t);Kt(t)}catch(n){throw new Error(e.text(p.UNEXPECTED_TEST_REGISTRATION_ERROR,{testObject:JSON.stringify(t),error:n}))}}(t);V.isNonActionable(t)||e.deferThrow(e.text(p.UNEXPECTED_TEST_REGISTRATION_ERROR,{testObject:JSON.stringify(t)}))}function Kt(t){V.pass(t)}function Xt(t,...s){const[i,r,a]=e.isFunction(s[1])?s:[void 0,...s];!function(t,n){const s="test";e.invariant(e.isStringValue(t),e.text(p.INVALID_PARAM_PASSED_TO_FUNCTION,{fn_name:s,param:"fieldName",expected:"string"})),e.invariant(e.isFunction(n),e.text(p.INVALID_PARAM_PASSED_TO_FUNCTION,{fn_name:s,param:"callback",expected:"function"}))}(t,r);const o={fieldName:t,groupName:N.useX().groupName,message:i,testFn:r};return n.Bus.useEmit(wt.TEST_RUN_STARTED),xt(jt,o,a)}!function(t){t.TEST_RUN_STARTED="test_run_started",t.TEST_COMPLETED="test_completed",t.ALL_RUNNING_TESTS_FINISHED="all_running_tests_finished",t.REMOVE_FIELD="remove_field",t.RESET_FIELD="reset_field",t.RESET_SUITE="reset_suite",t.SUITE_RUN_STARTED="suite_run_started",t.SUITE_CALLBACK_RUN_FINISHED="SUITE_CALLBACK_RUN_FINISHED",t.DONE_TEST_OMISSION_PASS="DONE_TEST_OMISSION_PASS"}(wt||(wt={}));const qt=e.assign(Xt,{memo:function(t){return function(s,...i){const[r,a,o]=i.reverse();return function(t,s){const i=N.useX().testMemoCache,r=i.get(t);if(e.isNull(r))return i(t,s);const[,a]=r;if(V.isCanceled(a))return i.invalidate(t),i(t,s);return n.VestRuntime.addNodeToHistory(a),a}([Q(),s,n.VestRuntime.useCurrentCursor()].concat(r),(function(){return t(s,o,a)}))}}(Xt)});function Ht(){return{group:kt,include:Bt,omitWhen:yt,only:j,optional:R,skip:K,skipWhen:ht,test:qt}}function Yt(){const t=n.VestRuntime.useAvailableRoot(),s=E.getOptionalFields(t);if(e.isEmpty(s))return;const i=new Set;function r(e){const{fieldName:n}=V.getData(e);i.has(n)&&(V.omit(e),E.setOptionalField(t,n,(t=>Object.assign(Object.assign({},t),{applied:!0}))))}Nt.walkTests((n=>{if(V.isPending(n))return;const{fieldName:s}=V.getData(n);i.has(s)?r(n):function(n){const{fieldName:s}=V.getData(n),a=E.getOptionalField(t,s);!0===e.optionalFunctionValue(a.rule)&&i.add(s);r(n)}(n)})),n.Bus.useEmit(wt.DONE_TEST_OMISSION_PASS)}function zt(){const t=n.Bus.useBus();return s(wt.TEST_COMPLETED,(t=>{if(V.isCanceled(t))return;const{fieldName:n}=V.getData(t);!function(t){const[n]=J();t&&!Tt.hasRemainingWithTestNameMatching(t)&&e.isArray(n[t])&&e.callEach(n[t])}(n)})),s(wt.TEST_RUN_STARTED,(()=>{})),s(n.RuntimeEvents.ISOLATE_PENDING,(t=>{V.is(t)&&V.setPending(t),function(t){t.status=A(t.status,O.PENDING)}(t)})),s(n.RuntimeEvents.ISOLATE_DONE,(e=>{V.is(e)&&t.emit(wt.TEST_COMPLETED,e),function(t){t.status=A(t.status,O.DONE)}(e),Tt.hasPending()||t.emit(wt.ALL_RUNNING_TESTS_FINISHED)})),s(wt.DONE_TEST_OMISSION_PASS,(()=>{})),s(wt.ALL_RUNNING_TESTS_FINISHED,(()=>{Nt.someTests(V.isAsyncTest)&&Yt(),function(){const[t]=z();e.callEach(t)}()})),s(wt.RESET_FIELD,(t=>{Nt.resetField(t)})),s(wt.SUITE_RUN_STARTED,(()=>{$()})),s(wt.SUITE_CALLBACK_RUN_FINISHED,(()=>{Yt()})),s(wt.REMOVE_FIELD,(t=>{Nt.removeTestByFieldName(t)})),s(wt.RESET_SUITE,(()=>{$(),n.VestRuntime.reset()})),{subscribe:function(e){return t.on("*",(()=>{e()})).off}};function s(e,n){t.on(e,((...t)=>{Z(),n(...t)}))}}function Jt(){return Object.freeze(e.assign({done:n.VestRuntime.persist(Qt)},vt()))}function Qt(...t){const[n,s]=t.reverse(),i=Jt();if(function(t,n,s){var i,r;return!!(!e.isFunction(t)||n&&e.numberEquals(null!==(r=null===(i=s.tests[n])||void 0===i?void 0:i.testCount)&&void 0!==r?r:0,0))}(n,s,i))return i;const r=()=>n(vt());return Tt.hasRemainingWithTestNameMatching(s)?(function(t,n){const[,s]=J(),[,i]=z();n?s((s=>e.assign(s,{[n]:(s[n]||[]).concat(t)}))):i((e=>e.concat(t)))}(r,s),i):(r(),i)}function Zt(...t){const[s,i]=t.reverse();!function(t){e.invariant(e.isFunction(t),p.SUITE_MUST_BE_INITIALIZED_WITH_FUNCTION)}(s);const r=function({suiteName:t,VestReconciler:s}){const i={doneCallbacks:e.tinyState.createTinyState((()=>[])),fieldCallbacks:e.tinyState.createTinyState((()=>({}))),suiteId:e.seq(),suiteName:t,suiteResultCache:H};return n.VestRuntime.createRef(s,i)}({suiteName:i,VestReconciler:Mt});function a(...t){return N.run({suiteParams:t},(()=>{return n.Bus.useEmit(wt.SUITE_RUN_STARTED),e=function(t,...e){const s=n.Bus.useEmit();return()=>(t(...e),s(wt.SUITE_CALLBACK_RUN_FINISHED),Jt())}(s,...t),n.Isolate.create(c,e,{optional:{}});var e})).output}const o=$t(...t);return n.VestRuntime.Run(r,(()=>{const t=zt();return e.assign(n.VestRuntime.persist(a),Object.assign(Object.assign({dump:n.VestRuntime.persist((()=>n.VestRuntime.useAvailableRoot())),get:n.VestRuntime.persist(vt),remove:n.Bus.usePrepareEmitter(wt.REMOVE_FIELD),reset:n.Bus.usePrepareEmitter(wt.RESET_SUITE),resetField:n.Bus.usePrepareEmitter(wt.RESET_FIELD),resume:n.VestRuntime.persist(tt),runStatic:(...t)=>o(...t),subscribe:t.subscribe},(s=n.VestRuntime.persist(vt),{getError:(...t)=>s().getError(...t),getErrors:(...t)=>s().getErrors(...t),getErrorsByGroup:(...t)=>s().getErrorsByGroup(...t),getWarning:(...t)=>s().getWarning(...t),getWarnings:(...t)=>s().getWarnings(...t),getWarningsByGroup:(...t)=>s().getWarningsByGroup(...t),hasErrors:(...t)=>s().hasErrors(...t),hasErrorsByGroup:(...t)=>s().hasErrorsByGroup(...t),hasWarnings:(...t)=>s().hasWarnings(...t),hasWarningsByGroup:(...t)=>s().hasWarningsByGroup(...t),isPending:(...t)=>s().isPending(...t),isTested:(...t)=>s().isTested(...t),isValid:(...t)=>s().isValid(...t),isValidByGroup:(...t)=>s().isValidByGroup(...t)})),Ht()));var s}))}function $t(...t){return e.assign(((...n)=>{const s=Zt(...t),i=s(...n);return Object.freeze(e.assign({dump:s.dump},i))}),Object.assign({},Ht()))}const te=p.WARN_MUST_BE_CALLED_FROM_TEST;Object.defineProperty(exports,"enforce",{enumerable:!0,get:function(){return t.enforce}}),exports.create=Zt,exports.each=function(t,s){e.invariant(e.isFunction(s),p.EACH_CALLBACK_MUST_BE_A_FUNCTION),function(t){n.Isolate.create(i,t,{allowReorder:!0})}((()=>{t.forEach(((t,e)=>{s(t,e)}))}))},exports.group=kt,exports.include=Bt,exports.mode=function(t){const[,e]=g();e(t)},exports.omitWhen=yt,exports.only=j,exports.optional=R,exports.registerReconciler=function(t){Vt.includes(t)||Vt.push(t)},exports.skip=K,exports.skipWhen=ht,exports.staticSuite=$t,exports.suiteSelectors=nt,exports.test=qt,exports.warn=function(){const t=(n=p.HOOK_CALLED_OUTSIDE,N.useX(n).currentTest);var n;e.invariant(t,te),V.warn(t)};
//# sourceMappingURL=vest.production.js.map
